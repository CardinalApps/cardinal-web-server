(()=>{"use strict";var e={933:e=>{e.exports=require("electron")},747:e=>{e.exports=require("fs")}},t={};function n(s){var i=t[s];if(void 0!==i)return i.exports;var r=t[s]={exports:{}};return e[s](r,r.exports,n),r.exports}(()=>{function e(e){return new t(e)}class t{constructor(e){if(e)if(this.selector=e,"document"===e)this.els=[document];else if("window"===e)this.els=[window];else if(e instanceof Element)this.els=[e];else if(NodeList.prototype.isPrototypeOf(e))this.els=e;else if(e instanceof DocumentFragment)this.els=[e];else if(Array.isArray(e)&&e.length){let t=!0;for(let n of e)n instanceof Element||(t=!1);t&&(this.els=e)}else if(Array.isArray(e)&&!e.length)this.els=[];else{if(e instanceof t)throw new Error(`You cannot create new __Object's using exisitng __Object's. The given __Object has the selector: ${e.selector}`);this.els=Array.from(document.querySelectorAll(e))}}each(e){if(void 0===this.els||null===this.els)throw new Error(`Cannot loop elements within __Object. The invalid selector is: ${this.selector}`);if(!e||"function"!=typeof e)throw new Error("Cannot loop elements within __Object. Check your callback function.");for(let t=0;t<this.els.length;t++)e(this.els[t],t);return this}el(){if(this.els.length)return 1!==this.els.length&&console.warn(".el() was called on an __Object that has more than 1 item"),this.els[0]instanceof Element||console.warn(".el() returned an item that was not an Element"),this.els[0];console.warn(".el() was called on an __Object that has no items")}on(e,t,n){let s;"object"!=typeof window.__delegations&&(window.__delegations={}),"object"!=typeof window.__delegationForwarders&&(window.__delegationForwarders={}),"function"==typeof t?(s=t,t=!1):("boolean"==typeof t||t instanceof Element)&&"function"==typeof n&&(s=n);let i=[],r=!1;if(t instanceof Element||!0===t?(r=!0,i=t instanceof Element?[t]:[document]):this.els.length?1===this.els.length&&this.els[0]instanceof Element?i=[this.els[0]]:this.els instanceof NodeList?i=Array.from(this.els):Array.isArray(this.els)&&(i=this.els):(r=!0,i=[document]),r)for(let t of i)t.addEventListener(e,(e=>{if(e.target.matches(this.selector))s.call(e.target,e);else{let t=e.target.closest(this.selector);t&&s.call(t,e)}}));else for(let t of i)t.addEventListener(e,(e=>{s.call(t,e)}))}off(e,t){if(!(e in window.__delegations))throw new Error(`Trying to remove delegated event handler that doesn't exist: ${e}`);for(let n in window.__delegations[e]){let s=window.__delegations[e][n];s.selector===this.selector&&t===s.cb&&window.__delegations[e].splice(n,1)}window.__delegations[e].length||(delete window.__delegations[e],document.removeEventListener(e,window.__delegationForwarders[e]))}addClass(...e){for(let t of e)this.each((e=>{e.classList.add(t)}));return this}removeClass(...e){for(let t of e)this.each((e=>{e.classList.remove(t)}));return this}toggleClass(...e){for(let t of e)this.each((e=>{e.classList.contains(t)?e.classList.remove(t):e.classList.add(t)}))}hasClass(e){let t=!1;return this.each((n=>{n.classList.contains(e)&&(t=!0)})),t}attr(e,t){if(void 0===t){if(1===this.els.length){if(this.els[0].hasAttribute(e)){let t=this.els[0].getAttribute(e);return"string"==typeof t&&""===t?null:this._readAttrValue(t)}return}{let t=[];return this.each((n=>{n.hasAttribute(e)&&""!==n.getAttribute(e)&&t.push(this._readAttrValue(n.getAttribute(e)))})),t}}return this.each((n=>{n.setAttribute(e,this._prepareForAttr(t))})),this}hasAttr(e){let t=!0;return this.each((n=>{n.hasAttribute(e)||(t=!1)})),t}removeAttr(e){return this.each((t=>{t.removeAttribute(e)})),this}watchAttrs(e,t){this.each((n=>{new MutationObserver((e=>{t(e,n)})).observe(n,{attributes:!0,attributeOldValue:!0,attributeFilter:e})}))}value(e){if(void 0===e){let e=[];if(this.each((t=>{if(t.matches('input[type="file"]'))t.files instanceof FileList&&t.files.length?e.push(t.files):t.hasAttribute("data-value")?e.push(t.getAttribute("data-value")):e.push("");else if(t.matches('input[type="checkbox"]'))e.push(t.checked);else if(t.matches("select[multiple]")){let n=t.querySelectorAll("option:checked");for(let t of Array.from(n))e.push(t.value)}else e.push(t.value)})),!e.length)return;return 1===e.length&&(e=e[0]),e}return this.each((t=>{t.value=e})),this}_prepareForAttr(e){return"object"==typeof e?JSON.stringify(e):e}_readAttrValue(e){if(null==e)return e;if(!isNaN(e))return Number(e);let t;try{t=JSON.parse(e)}catch(t){return e}return t}css(e){if("string"==typeof e){let t=[];return this.each((n=>{let s=window.getComputedStyle(n)[e];"string"==typeof s&&s.includes("px")&&(s=Number(s.replace("px",""))),t.push(s)})),1===t.length?t[0]:t}if("object"==typeof e){let t="";for(let n in e){let s=e[n];"number"==typeof s&&(s=`${s}px`),t+=`${n}:${s};`}return this.each((e=>{e.setAttribute("style",t)})),this}}find(t){let n=[];return this.each((e=>{let s=e.querySelectorAll(t);s.length&&(n=[...n,...s])})),e(n)}firstChild(){let t=[];return this.each((e=>{let n=e.firstElementChild;null!==n&&t.push(n)})),t.length?e(t):null}lastChild(){let t=[];return this.each((e=>{let n=e.lastElementChild;null!==n&&t.push(n)})),t.length?e(t):null}parents(t){let n=[];return this.each((e=>{if(e===document)return this;let s=e.parentElement;for(;null!==s;)void 0!==t?s.matches(t)&&n.push(s):n.push(s),s=s.parentElement})),e(n)}hasParent(t){if(!this.els.length)throw new Error("Cannot call __().hasParent() on __Object without matched elements.");let n=!1;return this.each((s=>{if(n)return;let i=e(s).parents();i.els.length&&i.each((e=>{(t instanceof Element&&t===e||"string"==typeof t&&e.matches(t))&&(n=!0)}))})),n}closest(t){let n=[];return this.each((e=>{let s=e.closest(t);s&&n.push(s)})),e(n)}siblings(t,n){let s=[];return this.each((e=>{s="prev"===t?[...s,...this._getPrevSiblings(e,n)]:"next"===t?[...s,...this._getNextSiblings(e,n)]:"all"===t?[...s,...this._getAllSiblings(e,n)]:[...s,...this._getAllSiblings(e)]})),e(s)}_getAllSiblings(e,t){return[...this._getPrevSiblings(e,t).reverse(),e,...this._getNextSiblings(e,t)]}_getPrevSiblings(e,t){let n=[],s=e.previousElementSibling;for(;s;)void 0!==t?s.matches(t)&&n.push(s):n.push(s),s=s.previousElementSibling;return n}_getNextSiblings(e,t){let n=[],s=e.nextElementSibling;for(;s;)void 0!==t?s.matches(t)&&n.push(s):n.push(s),s=s.nextElementSibling;return n}remove(){this.each((e=>{e.remove()}))}removeChildren(){return this.each((e=>{e.innerHTML=""})),this}html(e){return this.each((t=>{t.innerHTML=e})),this}text(e){return this.each((t=>{t.innerText=e})),this}prependHtml(e){return this._insertHtml(e,"prepend")}appendHtml(e){return this._insertHtml(e,"append")}before(t){if(t)return this._insertHtml(t,"before");let n=[];return this.each((e=>{n.push(e.previousElementSibling)})),e(n)}after(t){if(t)return this._insertHtml(t,"after");let n=[];return this.each((e=>{n.push(e.nextElementSibling)})),e(n)}moveTo(e,t="afterbegin"){return this.each((n=>{e.insertAdjacentElement(t,n)})),this}_insertHtml(t,n="prepend"){let s=[];return this.each((e=>{"prepend"===n?t instanceof DocumentFragment||t instanceof Element?s.push(e.insertBefore(t,e.firstChild)):"string"==typeof t&&(e.insertAdjacentHTML("afterbegin",t),s.push(e.firstElementChild)):"append"===n?t instanceof DocumentFragment||t instanceof Element?s.push(e.appendChild(t)):"string"==typeof t&&(e.insertAdjacentHTML("beforeend",t),s.push(e.lastElementChild)):"before"===n?"string"==typeof t&&(e.insertAdjacentHTML("beforebegin",t),s.push(e.previousElementSibling)):"after"===n&&"string"==typeof t&&(e.insertAdjacentHTML("afterend",t),s.push(e.nextElementSibling))})),e(s)}wrapInto(e){return this.each((t=>{let n=document.createElement("template");n.innerHTML=e,t.parentNode.insertBefore(n.content,t),t.previousSibling.appendChild(t)})),this}unwrap(){this.each((e=>{let t=document.createDocumentFragment();for(;e.firstChild;)t.appendChild(e.firstChild);e.parentNode.replaceChild(t,e)}))}randomStr(e=5,t="abcdefghijklmnopqrstuvwxyz1234567890"){let n=t.split(""),s=[];for(let t=1;t<=e;t++)s.push(n[Math.floor(Math.random()*n.length)]);return s.join("")}randomNumberBetween(e,t){return Math.round(Math.random()*(t-e)+e)}randomFromArray(e){let t=e[Math.floor(Math.random()*e.length)];return"object"==typeof t&&null!==t?{...t}:Array.isArray(t)?[...t]:t}odds(e,t=!1){let n=[],s=Object.values(e)[0].split("/").pop();for(let e=0;e<=s-1;e++)n.push("__UNFILLED__");if(t)return n;let i=0;for(let[t,s]of Object.entries(e)){let e=s.split("/")[0];for(let s=1;s<=e;s++)n[i]=t,i++}return this.randomFromArray(n)}shuffle(e){let t=e.length;for(;t>0;){let n=Math.floor(Math.random()*t);t--;let s=e[t];e[t]=e[n],e[n]=s}return e}getHtmlFromFile(e,t={},n=!1){return new Promise((async(e,t)=>(console.warn("Deprecated function. Switch to html.js."),"DEPRACATED")))}getJSONFromFile(e,t=!1,n=!1,s=!1){return new Promise((async(e,t)=>(console.warn("Deprecated function. Switch to html.js."),"DEPRACATED")))}getFileContents(e,t=!1){return new Promise(((s,i)=>{const r=n(747);if("object"!=typeof r)throw new Error("__ does not have access to the file system");if("__fileCache"in window||(window.__fileCache={}),!(e in window.__fileCache)||t)try{let t=r.readFileSync(__dirname+e,"utf8");window.__fileCache[e]=t,s(t)}catch(e){console.warn(e),i()}else s(window.__fileCache[e])}))}getTemplate(e){if(!this.els.length)return null;let t="";if(this.els[0].matches("template"))t=this.els[0].innerHTML;else for(let n of this.els){let s=n.querySelector(`template${e}`);s&&(t=s.innerHTML)}return""===t?(console.warn(`Could not find <template> for given selector: ${e}`),null):document.createRange().createContextualFragment(t)}width(){if(1!==this.els.length)throw new Error("__().width() expects exacly 1 item in the set of matches elements");return this.el().offsetWidth}height(){if(1!==this.els.length)throw new Error("__().height() expects exacly 1 item in the set of matches elements");return this.el().offsetHeight}position(){if(0===this.els.length)return[];let e=[];return this.each((t=>{let n=t.getBoundingClientRect();e.push({x:n.left,y:n.top})})),1===e.length?e[0]:e}animate(e,t,n){return new Promise(((s,i)=>{this.each((i=>{i.getAttribute("data-animation")&&i.classList.remove("animated",i.getAttribute("data-animation"));let r="string"==typeof t?t:void 0,o="string"==typeof n?n:void 0;r&&i.classList.add(r),o&&i.classList.add(o),i.setAttribute("data-animation",e),i.classList.add("animated",e),i.addEventListener("animationend",(()=>{i.classList.remove("animated",e,r,o),s(this)}))}))}))}show(e="block"){return this.each((t=>{t.style.display=e})),this}hide(){return this.each((e=>{e.style.display="none"})),this}enforceSingleton(t,n){return 2===e(t).els.length&&(e(n).remove(),console.error(`${t} is a singleton custom element; an extra copy was blocked from being created.`),!0)}trigger(e){let t=new MouseEvent(e,{view:window,bubbles:!0,cancelable:!0});this.each((e=>{e.dispatchEvent(t)}))}__doubleSlashesOnWindowsOnly(t){return"win32"===e("#app").attr("os")?t.replace(/\\/g,"\\\\"):t}convertSecondsToHHMMSS(e,t=!0,n=!0){let s=new Date(null);s.setSeconds(e);let i=s.toISOString().substr(11,8);return t&&"00:"===i.substr(0,3)&&(i=i.slice(3)),n&&"0"===i[0]&&(i=i.slice(1)),i}getArrayIntersection(e,t){return e.filter((e=>t.includes(e)))}infiniteScroll(e,t=".view-content"){if(1!==this.els.length)throw new Error("__().infiniteScroll() expects exactly 1 Element in the set of matched Elements");const n=this.els[0],s=document.querySelector(t),i=t=>{n.getBoundingClientRect().bottom<=s.getBoundingClientRect().bottom+600&&e()};return s.addEventListener("scroll",i),i}itemsPerRow(t){if(1!==this.els.length)throw new Error("__().itemsPerRow() expects exactly 1 Element in the set of matched Elements");let n=this.find(t);if(!n.els.length)return{0:0};let s=[];n.each((t=>{s.push(e(t).position().y)}));let i={};for(let e of s)i[e]=(i[e]||0)+1;return Object.values(i)}getShortest(){if(!this.els.length)throw new Error("__().getShortest() expects at least one Element in the set of matched Elements");let t=null,n=null;for(let e in this.els){let s=this.els[e].offsetHeight;(s<t||null===t)&&(t=s,n=e)}return e(this.els[n])}keepFocusWithin(t){if(!t)throw new Error("__().keepFocusWithin() expects a CSS selector");window.__focusTrap=n=>{if("Tab"!==n.code)return;let s=e(t).find(["a","button","select","input","textarea"].join(",")),i=[];s.each((e=>{let t=e.getBoundingClientRect();0!==t.width&&0!==t.height&&i.push(e)}));let r=i[0],o=i[i.length-1];if(null===n.target.closest(t))return n.preventDefault(),void r.focus();n.shiftKey||n.target!==o||(n.preventDefault(),r.focus()),n.shiftKey&&n.target===r&&(n.preventDefault(),o.focus())},document.addEventListener("keydown",window.__focusTrap)}releaseFocus(){document.removeEventListener("keydown",window.__focusTrap)}debouncer(e,t,n){let s;return function(){const i=arguments;let r=function(){console.log("later"),s=null,n||e.apply(null,i)},o=n&&!s;clearTimeout(s),s=setTimeout(r,t),o&&e.apply(null,i)}}throttler(e,t){let n=!1;return function(){n||(e.apply(null,arguments),n=!0,setTimeout((()=>{n=!1}),t))}}numberIsBetween(e,t,n,s=!0){let i=t,r=n;return s||(i=t+1),s||(r=n-1),e>=i&&e<=r}chunk(e,t=10){return e.reduce(((e,n,s)=>{let i=Math.floor(s/t);return e[i]||(e[i]=[]),e[i].push(n),e}),[])}}const s=e;class i{constructor(){this.appDebug=1,this.consoleColor="#1ba801",this.ipcListeners={},this._listenerForwarders={},this.wsListeners={},this._wsListenerForwarders={},this.ipcConnectionEstablished=!1,this.httpConnectionEstablished=!1,this.wsConnectionEstablished=!1}async init(e,t){if("ipc"===e)return await this._initIpc();if("http"===e)return await this._initHttp(t);if("ws"===e)return await this._initWs(t);throw new Error(`Unrecognized connection type "${e}"`)}async _initIpc(){try{this.electronIpc=n(933).ipcRenderer}catch(e){throw new Error("Cannot load Electron's ipcRenderer module")}return 200===await this.ipcAsk("status")?(this.ipcConnectionEstablished=!0,console.log("%cEstablished connection to Electron via IPC",`color:${this.consoleColor};`),!0):(console.error("Could not communicate with the Electron main process over IPC"),!1)}async _initHttp(e){if(!("scheme"in e))throw new Error("HTTP Bridge connection requires options.scheme");if(!("host"in e))throw new Error("HTTP Bridge connection requires options.host");if(!("port"in e))throw new Error("HTTP Bridge connection requires options.port");return this.httpServer=e,200===(await this.httpApi("/status")).status?(this.httpConnectionEstablished=!0,console.log("%cEstablished connection to HTTP server",`color:${this.consoleColor};`),!0):(console.error("Server did not return status 200"),!1)}async _initWs(e){if(!("scheme"in e))throw new Error("WebSocket Bridge connection requires options.scheme");if(!("host"in e))throw new Error("WebSocket Bridge connection requires options.host");if(!("port"in e))throw new Error("WebSocket Bridge connection requires options.port");this.wsServer=e;const t=`${this.wsServer.scheme}${this.wsServer.host}:${this.wsServer.port}`,n=e=>{this.BridgeWebSocket=new WebSocket(`${t}/bridge`),this.BridgeWebSocket.addEventListener("open",(t=>{e()})),this.BridgeWebSocket.addEventListener("message",(e=>{let t=JSON.parse(e.data),n=t.channel,s=t.message;if("connection-id"===n&&("connectionId"in this.wsServer?console.warn("Why is this connection receiving another connectionId?"):this.wsServer.connectionId=s),console.log(`Bridge received WebSocket message on channel ${n}`,s),n in this.wsListeners&&Array.isArray(this.wsListeners[n]))for(let e of this.wsListeners[n])e(s)})),this.BridgeWebSocket.addEventListener("error",(t=>{console.error("WebSocket error event",t),e(!0)})),this.BridgeWebSocket.addEventListener("close",(e=>{console.log("%cWebSocket connection closed",`color:${this.consoleColor};`)}))};return new Promise(((e,t)=>{let s=!1,i=!1,r=!1;setTimeout((()=>{i||s||(console.warn("WebSocket connection timed out while trying to establish initial connection"),r=!0,e(!1))}),2e3),n((t=>{if(!r){if(t)return s=!0,e(!1);i=!0,this.wsConnectionEstablished=!0,console.log("%cEstablished connection to WebSocket server",`color:${this.consoleColor};`),e(!0)}}))}))}ipcSay(e,t){this.electronIpc.send(e,t)}ipcAsk(e,t){return new Promise(((n,s)=>{this.electronIpc.invoke(e,t).then((e=>{n(e)}))}))}ipcListen(e,t){e in this.ipcListeners||(this.ipcListeners[e]=[]),this.ipcListeners[e].push(t),this.electronIpc.rawListeners(e).length||(this._listenerForwarders[e]=function(n,s){if(Array.isArray(this.ipcListeners[e]))for(let t of this.ipcListeners[e])t(s,n);else console.warn(`Tried to trigger callbacks for ipc channel '${e}' but no callbacks were registered. Should there still be an ipc forwarder for this event?`),console.log(e),console.log(t)}.bind(this),this.electronIpc.on(e,this._listenerForwarders[e]))}httpApi(e,t="GET",n=null){return new Promise(((s,i)=>{let r=`${this.httpApiUrl()}${e}`;var o=new XMLHttpRequest;o.addEventListener("error",(()=>{i()})),o.addEventListener("load",(function(e){let t={status:this.status,statusRange:Number(this.status.toString()[0]),response:"(Unparsed)",event:this};try{t.response=JSON.parse(this.response)}catch(e){t.response=this.response}s(t)})),"object"==typeof n&&null!==n&&(n=JSON.stringify(n)),o.open(t,r),o.send(n)}))}httpApiUrl(){return`${this.httpServer.scheme}${this.httpServer.host}:${this.httpServer.port}/api`}wsSay(e,t){if(!this.wsConnectionEstablished)return console.error("No WebSocket Connection"),!1;let n=JSON.stringify({channel:e,message:t});try{this.BridgeWebSocket.send(n)}catch(e){throw console.error("Error sending WebSocket message"),e}return!0}async wsListen(e,t){e in this.wsListeners||(this.wsListeners[e]=[]),await this.wsSay("add-channel",e),this.wsListeners[e].push(t)}removeListener(e,t,n=!1){return n?this.removeWsListener(e,t):this.removeIpcListener(e,t),!0}removeIpcListener(e,t){if(e in this.ipcListeners){for(let n in this.ipcListeners[e])this.ipcListeners[e][n]===t&&this.ipcListeners[e].splice(n,1);this.ipcListeners[e].length||(delete this.ipcListeners[e],this.electronIpc.removeListener(e,this._listenerForwarders[e]))}else console.trace(`Trying to remove IPC listener that does not exist: ${e}. This can happen if a custom element did not fully execute its connectedCallback() before its disconnectedCallback() was invoked. If it happens regularily, it's probably an extra Bridge.removeListener().`)}removeWsListener(e,t){if(e in this.wsListeners){for(let n in this.wsListeners[e])this.wsListeners[e][n]===t&&this.wsListeners[e].splice(n,1);this.wsListeners[e].length||delete this.wsListeners[e]}else console.warn(`Trying to remove WS listener that does not exist: ${e}. This can happen if a custom element did not fully execute its connectedCallback() before its disconnectedCallback() was invoked. If it happens regularily, it's probably an extra Bridge.removeListener().`)}__showListeners(e){console.log(this.electronIpc.rawListeners(e))}cleanup(){this.electronIpc.removeAllListeners(),this.ipcListeners={},this._listenerForwarders={},this.wsListeners={},this._wsListenerForwarders={}}}var r=/[\-\[\]{}()+?.,\\\^$|#\s]/g,o=/([:*])(\w+)/g;function a(e,t){var n=exports.toString.call(e).charAt(8);return"R"===n?e.test(t):"F"===n?e(t):e==t}function l(e,t){var n={},s=[],i=e;return"string"==typeof e?(i=(i=i.replace(r,"\\$&")).replace(o,(function(e,t,n){return s.push(n),":"===t?"([^/]*)":"(.*)"})),i=new RegExp("^"+i+"$"),n.parse=function(e){var n,r,o=0,l={},c=e.match(i);if(!c)return null;for(;o<s.length;){if(n=s[o++],r=c[o],t&&n in t&&!a(t[n],r))return null;l[n]=r}return l},n.stringify=function(t){var n,s,i=e;for(n in t)s=new RegExp("[:*]"+n+"\\b"),i=i.replace(s,t[n]);return i.replace(o,"")}):(n.parse=function(e){var t=e.match(i);return t&&{captures:t.slice(1)}},n.stringify=function(){return""}),n}const c={};function d(e,t={},n=Router.currentLang||"en"){return new Promise((async(s,i)=>{if(e instanceof DocumentFragment){let t=document.createElement("div");t.appendChild(e),e=t.innerHTML,t.remove()}if("string"!=typeof e||!e.length)return console.warn("html() was given an empty string, or something other than a string"),void s(e);"/"!==e[0]&&"\\"!==e[0]||(e=await u(e)),e=await function(e,t){return new Promise((async(n,s)=>{let i=h("inc",e);if(i.length){for(let n of i)await new Promise((async(s,i)=>{let r;try{r=".json"===n.slice(-5)?await p(n,"string"):await d(await u(n),t),e=e.replace(`{inc{${n}}}`,r),s()}catch(e){console.log(e),i()}}));n(e)}else n(e)}))}(e,t),s(e=function(e,t){if(!("i18n"in window))return;if(!(t in window.i18n))return;let n=h("i18n",e);if(!n.length)return e;for(let s of n)e=e.replace(`{i18n{${s}}}`,window.i18n[t][s]||s);return e}(e=function(e,t){if(!Object.keys(t).length)return e;let n=h("",e);if(!n.length)return e;for(let s of n)if(s in t){let n=t[s];null==n&&(n=""),e=e.replace(`{{${s}}}`,n)}return e}(e=function(e){return e.replace(/<!--[\s\S]*?-->/g,"")}(e),t),n))}))}function h(e,t){let n=[];if(!t.includes(`{${e}{`))return n;let s=t.split(`{${e}{`);for(let e=0;e<=s.length-1;e++)0!==e&&n.push(s[e].split("}}")[0]);return n}function u(e,t=!1){return new Promise(((s,i)=>{const r=n(747);if("object"!=typeof r)throw new Error("html.js does not have access to the file system");if(!(e in c)||t)try{let t=r.readFileSync(__dirname+e,"utf8");c[e]=t,s(t)}catch(e){console.warn(e),i()}else s(c[e])}))}function p(e,t="object",n=!1){return new Promise((async(s,i)=>{try{let i=await u(e,n),r=JSON.parse(i.trim());"string"===t?s(JSON.stringify(r)):"object"===t&&s(r)}catch(t){throw console.log(t),new Error("JSON file contained invalid JSON: "+e)}}))}class g{constructor(e){["mode","root","routes","langs","defaultLang"].forEach((t=>{if(!e.hasOwnProperty(t))throw new Error(`Router requires ${t} on init`)})),this.mode=e.mode,this.root=e.root,this.buttonSelector=".router-link",this.viewContentSelector=".view-content",this.cacheViews=e.cacheViews||!1,this.givenRoutes=e.routes,this.currentRoute=null,this.currentHref=null,this.models="models"in e?e.models:{},this.langs=e.langs,this.defaultLang=e.defaultLang,this.currentLang=e.currentLang||e.defaultLang,this._viewCache={},this._history=[],this._maxHistoryEntries=50,this._scrollTopDelay=0,this.currentViewWasLoadedFromCache=null,this._currentIndexInHistory=0,this.currentViewParams={},this._dontCacheCurrentViewOnNavAway=!1,this.consoleColor="#47aac9",this._registerEventHandlers(),this._buildRoutesReference(),this._buildModelsObject(),this._buildViewsObject()}go(e,t=!1){return new Promise((async(n,s)=>{if(void 0===e)throw new Error("Router.go() requires a URL");let i=this._isValidHref(e);if(!1===i)throw new Error("Route is invalid");(t||e!==this.currentHref)&&(this._saveScrollTopBeforeNavAway(),await this._loadRoute(i.route,e,i.params,t),this._currentIndexInHistory<this._history.length-1&&(this._history=this._history.slice(0,this._currentIndexInHistory+1)),this._addToHistory(e),this._currentIndexInHistory=this._history.length-1)}))}refresh(e=!0){this.go(this.currentHref,e)}async back(e=1){let t=this._currentIndexInHistory-e;if(t<0)return;let n=this._history[t].href,s=this._isValidHref(n);this._saveScrollTopBeforeNavAway(),await this._loadRoute(s.route,n,s.params),this._currentIndexInHistory=t,this._setScrollTop()}async forward(e=1){let t=this._currentIndexInHistory+e;if(t>this._history.length-1)return;let n=this._history[t].href,s=this._isValidHref(n);this._saveScrollTopBeforeNavAway(),await this._loadRoute(s.route,n,s.params),this._currentIndexInHistory=t,this._setScrollTop()}_setScrollTop(e=null){null===e&&(e=this._currentIndexInHistory),setTimeout((()=>{document.querySelector(this.viewContentSelector).scrollTop=this._history[e].scrollTop}),this._scrollTopDelay)}_buildRoutesReference(){let e=[];for(let t of this.givenRoutes)for(let n of this.langs)e.push({route:`/${n}${t.route}`,view:t.view,parent:t.parent||null});this.routes=e}_buildViewsObject(){let e={};for(let t of this.givenRoutes)for(let n of this.langs)e[`/${n}${t.route}`]=t.view;this.viewsObject=e}_buildModelsObject(){let e={};for(let t of this.givenRoutes)for(let n of this.langs)void 0!==t.model&&(e[`/${n}${t.route}`]=t.model);this.modelsObject=e}_isValidHref(e){if(void 0===e||""===e||"string"!=typeof e)return!1;this.langs.includes(e.split("/")[1])||(e="/"+this.currentLang+e);for(let t of this.routes){let n=l(t.route).parse(e);if(null!==n){for(let e in n)"id"===e&&(n[e]=parseInt(n[e]));return{href:e,route:t.route,params:n}}}return console.warn("Invalid href:",e),!1}async _loadRoute(e,t,n,i=!1){return new Promise((async(r,o)=>{Bridge.appDebug&&console.log(`%cLoading route: ${e}, hardRefresh: ${i}`,`color:${this.consoleColor};`),this.cacheViews&&null!==this.currentHref&&(this._dontCacheCurrentViewOnNavAway?this._dontCacheCurrentViewOnNavAway=!1:this._viewCache[this.currentHref]=s(this.root).el().innerHTML),s(this.root).removeChildren(),"ContextMenu"in window&&ContextMenu.closeAllContextMenus(),s("html").attr("lang",e.split("/")[1]),this.currentViewParams=n;let a=this.viewsObject[e],l="";if(this.cacheViews&&t in this._viewCache&&!i)l=this._viewCache[t],this.currentViewWasLoadedFromCache=!0;else{l=await u(`/views/${a}`);let t=null;if(this.modelsObject[e]){let n=this.modelsObject[e];t=await this.models[n]()}l=t?await d(l,t):await d(l),this.currentViewWasLoadedFromCache=!1}s(this.root).html(l),this.currentRoute=e,this.currentHref=t,this._setRouterLinkActiveStates(),s(this.root).attr("data-current-route",e),r()}))}_setRouterLinkActiveStates(){s(this.buttonSelector).removeClass("active"),s(`${this.buttonSelector}[href="${this.currentHref}"]`).addClass("active");let e={};for(let t of this.routes)e[t.route]=t.parent;let t=[];const n=s=>{let i=e[s];i&&(t.push(i),n("/"+this.currentLang+i))};if(n(this.currentRoute),t.length)for(let e of t)s(`${this.buttonSelector}[href="${e}"]`).addClass("active")}_addToHistory(e){let t={href:e,scrollTop:0};this._history.push(t),this._history.length+1>this._maxHistoryEntries&&(this._history=this._history.slice(-Math.abs(this._maxHistoryEntries)))}_saveScrollTopBeforeNavAway(){let e=document.querySelector(this.viewContentSelector);e&&(this._history[this._currentIndexInHistory].scrollTop=e.scrollTop)}_registerEventHandlers(){let e=this;document.addEventListener("mousedown",(e=>{4===e.which?this.back():5===e.which&&this.forward()}));let t,n=!1;document.addEventListener("mousewheel",(e=>{if(e.wheelDeltaX<-200||e.wheelDeltaX>200){if(n)return;n=!0;let s=e.wheelDeltaX>0?"back":"forward";"back"===s?this.back():"forward"===s&&this.forward(),t=setTimeout((()=>{console.log("%cunlocking swipe",`color:${this.consoleColor};`),n=!1}),750)}})),s(this.buttonSelector).on("click",!0,(function(t){if(t.preventDefault(),0===t.button){let n=!1;n="darwin"===s("#app").attr("os")?t.metaKey:t.ctrlKey,e.go(s(this).attr("href"),n)}})),s(this.buttonSelector).on("keyup",(function(e){"Space"===e.code&&s(this).trigger("click")}))}setLang(e){this.deleteViewCache(),this.deleteHistory(),s("html").attr("lang",e),this.currentLang=e}deleteHistory(){this._history=[]}deleteViewCache(){this._viewCache={},this._dontCacheCurrentViewOnNavAway=!0}}class m extends HTMLElement{async connectedCallback(){this.locked=this.hasAttribute("locked"),this.locked||(this.debug=0,this.consoleColor="#f05ee4",this.interactingClassName="interacting",this.spawned=!1,this.built=!1,this.rendered=!1,this.attrObservers=[],this.__preservedProps=this.props,this.props=this._newPropsProxiedObject(),this.debug&&(console.log("%cLowrider connectedCallback for:",`color:${this.consoleColor};`),console.log(this)),this.classList.remove(this.interactingClassName),await this.spawn(),this.isUsingLazyRenderMode()?this.enableLazyRender():this.isUsingRenderQueue()?this.addToRenderQueue():this._finishRender())}disconnectedCallback(){this.locked||(this._supportedInfiniteScrollEventListener&&this._supportedInfiniteScrollParent.removeEventListener("scroll",this._supportedInfiniteScrollEventListener),"onRemoved"in this&&this.onRemoved())}async spawn(e){if(!this.locked)return"onSpawn"in this&&!1===await this.onSpawn(e)?(this.spawned=!1,!1):(this.spawned=!0,!0)}async build(e){if(this.locked)return;let t;return"onBuild"in this&&(t=await this.onBuild(e),this.built=!1!==t),t}async load(){if("onLoad"in this&&this.onLoad(),"object"==typeof this.__preservedProps&&null!==this.__preservedProps)for(let[e,t]of Object.entries(this.__preservedProps))this.props[e]=t}async shouldBuild(){return!this.locked&&null===this.firstElementChild}_newPropsProxiedObject(){return new Proxy({},{set:(e,t,n)=>{e[t]=n;for(let e of this.querySelectorAll(`[data-prop="${t}"]`))e.innerHTML=n;return!0}})}_ensureGlobals(){"LowriderGlobals"in window||(window.LowriderGlobals={renderQueues:{}})}isUsingRenderQueue(){return this.hasAttribute("render-queue")}_createRenderQueue(e){if(e in window.LowriderGlobals.renderQueues)throw new Error(`Render queue ${e} already exists`);console.log(`Creating render queue ${e}`),window.LowriderGlobals.renderQueues[e]={queue:[],running:!1,runner:async()=>{if(window.LowriderGlobals.renderQueues[e].running)return void console.log("cant run twice, normal");window.LowriderGlobals.renderQueues[e].running=!0;let t=window.LowriderGlobals.renderQueues[e].queue;for(;t.length;){let n=t[0];n.classList.remove("in-render-queue"),await n._finishRender(),t.splice(0,1),console.log(`render queue ${e} rendered item`)}window.LowriderGlobals.renderQueues[e].running=!1,console.log(`Render queue ${e} cleared!`)}}}addToRenderQueue(){this._ensureGlobals();let e=this.getAttribute("render-queue")||"default";e in window.LowriderGlobals.renderQueues||this._createRenderQueue(e),window.LowriderGlobals.renderQueues[e].queue.push(this),this.classList.add("in-render-queue"),setTimeout((()=>{this._runRenderQueue(e)}),0)}_runRenderQueue(e){if(!(e in window.LowriderGlobals.renderQueues))throw new Error(`Render queue ${e} does not exist`);window.LowriderGlobals.renderQueues[e].running||window.LowriderGlobals.renderQueues[e].runner()}isUsingLazyRenderMode(){return this.hasAttribute("lazy-render")}enableLazyRender(){if("_intersectionObserver"in this&&this._intersectionObserver instanceof IntersectionObserver)throw new Error("Already observing visibility");this._lazyRenderAttrWatcher=this.watchAttr("lazy-render",(e=>{this.isUsingLazyRenderMode()&&this.disableLazyRender()})),this._intersectionObserver=new IntersectionObserver((async(e,t)=>{e[0].isIntersecting&&(this.disableLazyRender(),this.isUsingRenderQueue()?this.addToRenderQueue():this._finishRender())})),this._intersectionObserver.observe(this)}disableLazyRender(){if(!("_intersectionObserver"in this&&this._intersectionObserver instanceof IntersectionObserver))throw new Error("Must be observing visibility");this._lazyRenderAttrWatcher.disconnect(),this._lazyRenderAttrWatcher=null,this._intersectionObserver.disconnect(),this._intersectionObserver=null,this.hasAttribute("lazy-render")&&this.removeAttribute("lazy-render")}_finishRender(){return new Promise((async e=>{await this.shouldBuild()&&await this.build(),setTimeout((async()=>{await this.load(),this.rendered=!0,e(!0)}),0)}))}async render(e){if(!this.locked){if(this.isUsingLazyRenderMode()&&this.disableLazyRender(),this.attrObservers.length){for(let e of this.attrObservers)e.disconnect();this.attrObservers=[]}return this.rendered=!1,"onRemoved"in this&&await this.onRemoved(),await this.spawn(e),await this.build(e),setTimeout((()=>{this.load(e)}),0),this.rendered=!0,!0}}unlock(){this.locked=!1,this.removeAttribute("locked")}watchAttr(e,t){if(this.locked)return;Array.isArray(e)||(e=[e]);let n=new MutationObserver((e=>{t(e)}));return n.observe(this,{attributes:!0,attributeOldValue:!0,attributeFilter:e}),this.attrObservers.push(n),n}supportInfiniteScroll(e,t="body",n=600){const s=document.querySelector(t);let i=e.bind(this);s.addEventListener("scroll",(e=>{this.getBoundingClientRect().bottom<=s.getBoundingClientRect().bottom+n&&i()}))}supportInteractingState(e={}){if("rightClickEls"in e||(e.rightClickEls=[this]),"leftClickEls"in e||(e.leftClickEls=[...Array.from(this.querySelectorAll("dot-menu"))]),e.rightClickEls.length)for(let t of e.rightClickEls)t.addEventListener("mousedown",(e=>{3===e.which&&this.enterInteractingState()}));if(e.leftClickEls.length)for(let t of e.leftClickEls)t.addEventListener("mousedown",(e=>{1===e.which&&this.enterInteractingState()}));let t=Array.from(this.querySelectorAll('a, button, [tabindex="0"]'));if(t.length)for(let e of t)e.addEventListener("focus",(e=>{this.enterInteractingState()}))}enterInteractingState(){let e=this;e.classList.contains(this.interactingClassName)||(e._checkIfDoneInteracting=t=>{if(this.debug&&(console.log("%cchecking if done interacting with",`color:${this.consoleColor}`),console.log(e),console.log("%cmb or kb event",`color:${this.consoleColor}`),console.log(t)),t instanceof KeyboardEvent){if("Shift"===t.key||"Alt"===t.key||"Meta"===t.key||"Control"===t.key)return;if(t.target.closest("context-menu"))return;if(e.contains(t.target))return}if(t instanceof MouseEvent){if(3===t.which){if(e.contains(t.target))return;if(t.target.closest("context-menu"))return}if(1===t.which){let n=e.querySelector("dot-menu");if(n&&n.contains(t.target))return}}t.target.matches("context-menu .dropdown-item")||t.target.matches("context-menu .dropdown-item > span")||(document.querySelector("music-app").removeEventListener("mouseup",e._checkIfDoneInteracting),document.querySelector("music-app").removeEventListener("keyup",e._checkIfDoneInteracting),e.classList.remove(this.interactingClassName),e._checkIfDoneInteracting=null,this.debug&&(console.log("%cdone interacting with",`color:${this.consoleColor}`),console.log(e)))},e.classList.add(this.interactingClassName),document.querySelector("music-app").addEventListener("mouseup",e._checkIfDoneInteracting),document.querySelector("music-app").addEventListener("keyup",e._checkIfDoneInteracting))}enableDropArea(e,t){let n,s=this;e instanceof Element?(s=e,n=t):n=e,s.addEventListener("dragover",(e=>{e.preventDefault()})),s.addEventListener("dragenter",(e=>{e.preventDefault(),s.classList.add("drop-hovering")})),s.addEventListener("dragleave",(e=>{e.preventDefault(),s.classList.remove("drop-hovering")})),s.addEventListener("drop",(e=>{let t=e.dataTransfer.files;s.classList.remove("drop-hovering"),"function"==typeof n&&n(e,t)}))}static elementFactory(e){let t=document.createDocumentFragment(),n=document.createElement("div");t.appendChild(n),n.innerHTML=`<${e.name}></${e.name}>`;let s=n.firstElementChild;if("attrs"in e&&"object"==typeof e.attrs)for(let[t,n]of Object.entries(e.attrs))"string"!=typeof n&&(n=JSON.stringify(n)),s.setAttribute(t,n);if("bindings"in e&&"object"==typeof e.bindings)for(let[t,n]of Object.entries(e.bindings))s[t]=n;return s}static register(e,t){void 0===window.customElements.get(e)?window.customElements.define(e,t):console.warn(`Custom Element ${e} is already defined`)}}const f=m;async function w(e,t){switch(console.log(`%c${e.action}`,"color:#f39a11;"),e.action){case"openSettings":s("fullsize-settings").el().openSettingsPanel();break;case"zoom-in":if(Bridge.ipcConnectionEstablished){const{webFrame:e}=n(933);e.setZoomLevel(e.getZoomLevel()+.5)}break;case"zoom-out":if(Bridge.ipcConnectionEstablished){const{webFrame:e}=n(933);e.setZoomLevel(e.getZoomLevel()-.5)}break;case"reset-zoom":if(Bridge.ipcConnectionEstablished){const{webFrame:e}=n(933);e.setZoomLevel(0)}}}async function b(e,t){switch(console.log(`%c${e.action}`,"color:#f39a11;"),e.action){case"maximized":s(this).addClass("maximized"),s(this).removeClass("minimized");break;case"openSettings":s("music-settings").el().openSettingsPanel();break;case"swipe":"left"===e.direction?Router.back():"right"===e.direction&&Router.forward();break;case"back":Router.back();break;case"forward":Router.forward();break;case"play":Player.play();break;case"pause":Player.pause();break;case"playpause":Player.playPause();break;case"stop":Player.stop();break;case"next":Player.next();break;case"previous":Player.previous();break;case"togglequeue":s("music-app").toggleClass("queue-open");break;case"alert":alert(e.message);break;case"show-welcome":this.showWelcome();break;case"show-open-source":this.showOpenSource();break;case"show-about":this.showAbout();break;case"zoom-in":if("electron"===s("#app").attr("env")){const{webFrame:e}=n(933);e.setZoomLevel(e.getZoomLevel()+.5)}break;case"zoom-out":if("electron"===s("#app").attr("env")){const{webFrame:e}=n(933);e.setZoomLevel(e.getZoomLevel()-.5)}break;case"reset-zoom":if("electron"===s("#app").attr("env")){const{webFrame:e}=n(933);e.setZoomLevel(0)}}}const v=function(e){"Space"===e.code&&s(e.target).find("i").trigger("mouseup")},y=function(e){"Space"===e.code&&setTimeout((()=>{_(this)}),0)},S=function(e){setTimeout((()=>{_(this)}),0)};function _(e){let t=s(e).attr("data-transfer-focus-to-child")?e:"music-app",n=s(e).attr("data-transfer-focus-to"),i=s(t).find(n);i.els.length&&setTimeout((()=>{i.el().focus()}),0)}class C extends f{constructor(){var e;super(),console.groupCollapsed("%cC%co%cl%co%cu%cr %cI%cn%cd%ce%cx","font-weight:600; font-size:14px; color:red;","font-weight:600; font-size:14px; color:white;","font-weight:600; font-size:14px; color:red;","font-weight:600; font-size:14px; color:white;","font-weight:600; font-size:14px; color:red;","font-weight:600; font-size:14px; color:white;","font-weight:600; font-size:14px; color:red;","font-weight:600; font-size:14px; color:white;","font-weight:600; font-size:14px; color:red;","font-weight:600; font-size:14px; color:white;","font-weight:600; font-size:14px; color:red;"),console.log("%cOrange: Main process announcements","color:#f39a11;"),console.log("%cGreen: Bridge object instance","color:#5fb64a;"),console.log("%cBlue: UI Router object instance","color:#47aac9;"),console.log("%cPink: Audio playback","color:#d61fd0;"),console.log("Default: Other"),console.groupEnd(),this.maybeEnableDeveloperMode(),this.boundAnnouncementListener=b.bind(this),this.boundOnDocumentKeyDown=this.onDocumentKeyDown.bind(this),this.boundOnDocumentKeyUp=this.onDocumentKeyUp.bind(this),this.boundOnWindowResize=this.onWindowResize.bind(this),window.disableCustomCSS=()=>{document.querySelector("#user-custom-css").remove(),document.querySelector('textarea[name="custom_css"]').value="",window.localStorage.removeItem("custom_css")},this.enableModals(),e=this,s("button.icon-button").on("keydown",e,v),s("a[data-transfer-focus-to]").on("keydown",e,y),s("button[data-transfer-focus-to]").on("click",e,S),s(this).attr("os",process.platform),"electron"===this.getAttribute("env")&&setTimeout((async()=>{JSON.parse(window.localStorage.getItem("auto_check_for_updates"))&&this.checkForUpdates()}),4e3)}async maybeEnableDeveloperMode(){JSON.parse(window.localStorage.getItem("developer_mode"))?this.enableDeveloperMode():this.enableDeveloperMode(!1)}async enableDeveloperMode(e){!1===e?s(this).removeClass("developer-mode"):s(this).addClass("developer-mode")}async getDefaultServer(){let e=await Bridge.ipcAsk("get-option","default_server");return e?await Bridge.ipcAsk("db-api",{fn:"getRow",args:["servers",e]}):null}async connectToServer(e,t){if(!e)throw new Error("Host is required");if(!t)throw new Error("Port is required");try{await Bridge.init("http",{host:e,port:t,scheme:"http://"})}catch(e){return console.log("HTTP connection to Cardinal Server cannot be established. Not attempting WebSocket connection."),!1}try{await Bridge.init("ws",{host:e,port:parseInt(t)+1,scheme:"ws://"})}catch(e){console.log("WebSocket connection to server failed")}return!(!Bridge.httpConnectionEstablished||!Bridge.wsConnectionEstablished)}async showConnectionLockScreen(e){let t=e?`message="${e}"`:"";s(this).prependHtml(await d(`\n      <div id="win32-window-controls" class="win32-only">\n        {inc{/elements/music-app/templates/win32-window-control-buttons.html}}\n      </div>\n      <server-connect overlay ${t}></server-connect>`))}isConnectionLockScreenShowing(){return!!document.querySelector("server-connect[overlay]")}async autoConnectOrLock(){if(!("Bridge"in window))throw new Error("AutoConnect: Cannot auto connect, window.Bridge global is missing.");if(Bridge.httpConnectionEstablished&&Bridge.wsConnectionEstablished)return console.log("AutoConnect: Bridge is already connected."),!0;const e=await this.getDefaultServer();if(!e)return console.log("AutoConnect: No default server set, showing connection screen."),this.showConnectionLockScreen(),!1;const t=`${e.server_host}:${e.server_port_http}`;return await this.connectToServer(e.server_host,e.server_port_http)?(console.log(`AutoConnect: Automatically connected to server at ${t}.`),await this.maybeSetI18nViaHttp(),!0):(console.log(`AutoConnect: Could not connect to server at ${t}`),this.showConnectionLockScreen("autoconnect-failed"),!1)}async maybeSetI18nViaHttp(){if(!window.i18n){let e=await Bridge.httpApi("/i18n");200===e.status?window.i18n=e.response:console.error("i18n strings HTTP route did not return with status 200")}}async injectCustomCss(){let e=window.localStorage.getItem("custom_css"),t=document.querySelector("#user-custom-css");if(t&&t.remove(),e){let t=document.createElement("style");t.id="user-custom-css",t.textContent=e,document.head.append(t)}}async setColors(){let e=window.localStorage.getItem("color_theme")||"dark",t=window.localStorage.getItem("accent_color");e&&s(this).attr("color-theme",e),t&&document.documentElement.style.setProperty("--accent-color",t)}registerCommonEventHandlers(){Bridge.ipcListen("announcements",this.boundAnnouncementListener),document.addEventListener("keydown",this.boundOnDocumentKeyDown),document.addEventListener("keyup",this.boundOnDocumentKeyUp),window.addEventListener("resize",this.boundOnWindowResize),s("#win32-window-controls .minimize").on("click",(e=>{Bridge.ipcSay("minimize-player")})),s("#win32-window-controls .maximize").on("click",(e=>{Bridge.ipcSay("maximize-player")})),s("#win32-window-controls .restore").on("click",(e=>{Bridge.ipcSay("restore-player")})),s("#win32-window-controls .close").on("click",(e=>{Bridge.ipcSay("close-player")})),s("button#back-button").on("click",(e=>{1===e.which&&Router.back()})),s("a.external").on("click",this,(function(e){e.preventDefault();let t=s(this).attr("href");Bridge.ipcSay("open-url",t)})),"ContextMenu"in window&&ContextMenu.listenForRightClicks(this)}removeCommonEventHandlers(){Bridge.removeListener("announcements",this.boundAnnouncementListener),document.removeEventListener("keydown",this.boundOnDocumentKeyDown),document.removeEventListener("keyup",this.boundOnDocumentKeyUp),window.removeEventListener("resize",this.boundOnWindowResize)}onDocumentKeyDown(e){switch(e.which){case 16:this.classList.add("shift-down");break;case 17:this.classList.add("ctrl-down");break;case 18:this.classList.add("option-down");break;case 91:this.classList.add("cmd-down");break;case 32:for(let t of["input","textarea","button","a"])if(e.target.matches(t))return;e.preventDefault(),Player.playPause();break;case 37:Player.previous();break;case 39:Player.next()}}onDocumentKeyUp(e){switch(e.which){case 16:this.classList.remove("shift-down");break;case 17:this.classList.remove("ctrl-down");break;case 18:this.classList.remove("option-down");break;case 91:this.classList.remove("cmd-down");break;case 27:"ContextMenu"in window&&ContextMenu.closeAllContextMenus(),this.modal.closeAll(),s("context-menu").each((e=>e.closeAll()))}}onWindowResize(){0===window.screenX&&0===window.screenY||s(this).removeClass("maximized")}enableModals(){s("[data-modal]").on("click",this,(async e=>{let t=s(e.target),n=t.attr("data-modal"),i=document.querySelector(n);"modal"in this?this.modal.show(t.closest("#app").el(),i):console.warn("No `modal` handler set.")}))}async checkForUpdates(){if("electron"!==this.getAttribute("env"))return console.warn("Updates only available in Electron.");Bridge.ipcSay("check-for-updates-silently")}}const{shell:k}=n(933);function L(e,t="en"){return!t&&"Router"in window&&"currentLang"in window.Router&&(t=Router.currentLang),"i18n"in window?window.i18n.hasOwnProperty(t)?window.i18n[t].hasOwnProperty(e)?window.i18n[t][e]:e:(console.error(`Language ${t} does not exist in i18n.`),e):(console.error("Missing key-value i18n store"),e)}function E(e){!function(e){s(e).find("select").each((e=>{if(s(e).closest(".form-select").els.length)return;let t=s(e).hasAttr("multiple")?"form-multi-select":"form-select",n=s(e).attr("data-label")?`<span class="label-text">${s(e).attr("data-label")}</span>`:"",i=s(e).before(`\n      <div class="field ${t}">\n        ${n}\n        <div class="select-outer"></div>\n      </div>`);s(e).moveTo(i.find(".select-outer").el())}))}(e),function(e){s(e).find('input[type="checkbox"]').each((e=>{if(s(e).closest(".toggle-switch").els.length)return;let t=s(e).attr("data-label"),n=s(e).attr("data-align")?s(e).attr("data-align"):"left",i=!!s(e).attr("data-explanation")&&s(e).attr("data-explanation"),r="";i&&(r=`<i class="explanation tooltip far fa-question-circle" data-tooltip="${i}"></i>`);let o=`\n      <div class="field toggle-switch-field align-${n}">\n        <label>\n          <div class="toggle-switch">\n            <div class="switch"></div>\n            <div class="focus"></div>\n          </div>\n        </label>\n        <span class="label-text">${r}${t}</span>\n      </div>`,a=s(e).before(o).find(".switch").el();s(e).moveTo(a,"beforebegin")}))}(e),function(e){s(e).find('input[type="radio"]').each((e=>{if(s(e).closest(".radio-field").els.length)return;let t=s(e).attr("data-label")||"",n=`\n      <div class="field radio-field">\n        <label class="clicks" ${s(e).hasClass("color-swatch")?`style="background-color:${s(e).attr("value")};"`:""}></label>\n        <span class="label-text">${t}</span>\n      </div>`,i=s(e).before(n).find("label").el();s(e).moveTo(i,"afterbegin")}))}(e),function(e){s(e).find('input[type="file"]').each((e=>{if(!s(e).closest(".photo-input").els.length&&"image/*"===s(e).attr("accept")){s(e).wrapInto('<div class="photo-input field"></div>'),s(e).wrapInto("<label></label>");let t=s(e).closest(".photo-input"),n=s(e).attr("data-label"),i=L("choose-file");const r=()=>{let n=s(e).attr("data-original-value");n?t.find(".thumb").attr("style",`background-image: url('${s().__doubleSlashesOnWindowsOnly(n)}')`):(t.find(".thumb").removeAttr("style"),t.find('input[type="file"]').removeAttr("data-value"))};if(t.prependHtml(`<span class="label-text">${n}</span>`),t.find("label").appendHtml(`\n        <div class="thumb">\n          <span class="btn">${i}</span>\n        </div>\n      `),t.find(".thumb").appendHtml('\n        <button type="button" class="remove-photo icon-button">\n          <span tabindex="-1">\n            <i class="fas fa-times-circle"></i>\n          </span>\n        </button>\n      '),s(e).attr("data-value")){let n=s(e).attr("data-value");t.find(".thumb").attr("style",`background-image: url('${s().__doubleSlashesOnWindowsOnly(n)}')`),s(e).attr("data-original-value",n)}e.addEventListener("change",(n=>{let i=s(e).value();if(i instanceof FileList){let n=i[0];t.find(".thumb").attr("style",`background-image: url('${s().__doubleSlashesOnWindowsOnly(n.path)}')`),s(e).attr("data-value",n.path)}else r()})),t.find(".remove-photo").el().addEventListener("click",(e=>{t.find(".thumb").removeAttr("style"),t.find('input[type="file"]').el().value=null,t.find('input[type="file"]').attr("data-value","")}))}}))}(e),function(e){s(e).find('input[type="number"][maxlength]').each((e=>{e.addEventListener("change",(t=>{let n=parseInt(s(e).value()),i=parseInt(s(e).attr("maxlength"));n.length>i&&(n=parseInt(n.substring(0,i))),e.value=n}))})),s(e).find('input[type="number"][min], input[type="number"][max]').each((e=>{e.addEventListener("change",(t=>{let n=parseInt(s(e).value()),i=s(e).attr("min")?parseInt(s(e).attr("min")):0,r=s(e).attr("max")?parseInt(s(e).attr("max")):Number.MAX_SAFE_INTEGER;i&&n<i&&(n=i),r&&n>r&&(n=r),e.value=n}))}))}(e),function(e){s(e).find('input[type="text"], input[type="number"], textarea').each((e=>{if(s(e).closest(".text-input").els.length)return;let t=s(e).wrapInto('<label class="text-input"></label>').el(),n=s(t).attr("data-label");n?s(t).closest(".text-input").prependHtml(`<span class="label-text">${n}</span>`):s(t).addClass("no-label")}))}(e),function(e){s(e).find(".hidden-fields").each((e=>{let t="input, select, textarea, button, a";s(e).find(t).attr("tabindex","-1"),new MutationObserver((n=>{s(e).hasClass("show")?s(e).find(t).removeAttr("tabindex"):s(e).find(t).attr("tabindex","-1")})).observe(e,{attributes:!0,attributeFilter:["class"]})}))}(e),function(e){e.addEventListener("reset",(t=>{s(e).find(".photo-input").each((e=>{let t=e.querySelector('input[type="file"]');if(s(t).attr("data-original-value")){let n=s(t).attr("data-original-value");s(t).attr("data-value",n),s(e).find(".thumb").attr("style",`background-image: url('${s().__doubleSlashesOnWindowsOnly(n)}')`)}t.files=null,setTimeout((()=>{let e=new Event("change",{bubbles:!0});t.dispatchEvent(e)}),0)}))}))}(e),function(e){s(e).watchAttrs(["class"],(t=>{let n=s(e);n.hasClass("success")&&(n.find('button[type="submit"]').prependHtml('\n        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">\n          <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none" />\n          <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8" />\n        </svg>'),setTimeout((()=>{n&&(n.find(".checkmark").remove(),n.removeClass("success"))}),2e3))}))}(e)}function x(e,t,n){if("lang"!==e)return;console.log("Rerendering #app to change language"),Router.setLang(t);const s=document.querySelector("#app");s.classList.remove("settings-open"),s.render()}function I(e,t,n){"color_theme"===e&&document.querySelector("#app").setAttribute("color-theme",t)}function O(e,t,n){if("accent_color"!==e)return;window.localStorage.setItem("accent_color",t);let s=n.target.closest(".settings-panel").querySelector(".swatches .active");s&&s.classList.remove("active"),n.target.closest("label").classList.add("active"),document.documentElement.style.setProperty("--accent-color",t)}function A(e,t,n){"custom_css"===e&&(window.localStorage.setItem("custom_css",t),document.querySelector("#app").injectCustomCss())}function $(e,t,n){"developer_mode"===e&&(window.localStorage.setItem("developer_mode",t),document.querySelector("#app").maybeEnableDeveloperMode())}class B extends f{constructor(){super(),this.formId="#app-settings-form",this.boundOnDataSettingsAttrClick=this.onDataSettingsAttrClick.bind(this),this.onFieldChange=null,this._callbacks={onSettingChange:[],onClose:[]}}formSetup(){E(this.querySelector(this.formId)),this.setSyncGroups(),this.registerFieldEventListeners(),s(this.formId).on("submit",(e=>{e.preventDefault()})),this.watchSyncGroups();let e=window.localStorage.getItem("accent_color");e&&this.querySelector(`input[name="accent_color"][value="${e}"]`).closest("label").classList.add("active")}registerFieldEventListeners(){this.registerCallback("onSettingChange",x),this.registerCallback("onSettingChange",I),this.registerCallback("onSettingChange",O),this.registerCallback("onSettingChange",A),this.registerCallback("onSettingChange",$);let e=s(this).find(`${this.formId} button[name="factory-reset"]`);e.els.length&&e.each((e=>{e.addEventListener("click",(e=>{e.preventDefault(),confirm(L("settings.factory-reset.confirm"))&&confirm(L("danger-confirm"))&&Bridge.ipcSay("factory-reset")}))})),s(this).find(`${this.formId} button[name="manually-check-for-updates"]`).each((e=>{e.addEventListener("click",(async()=>{await Bridge.ipcSay("check-for-updates-and-prompt")}))}))}onDataSettingsAttrClick(e){let t=s(e.target).attr("data-settings");e.target.matches("[data-settings]")||(t=s(e.target.closest("[data-settings]")).attr("data-settings")),this.openSettingsPanel(t)}setSyncGroups(){s(`${this.formId} [data-sync-with-db]`).each((async e=>{let t,n=s(e).attr("name");if(t="electron-main"===s(e).attr("data-db")?await Bridge.ipcAsk("get-option",n):window.localStorage.getItem(n),null!==t){try{t=JSON.parse(t)}catch(e){}e.matches('[type="checkbox"]')||e.matches('[type="radio"]')?t?e.checked=!0:t||(e.checked=!1):s(e).value(t)}}))}watchSyncGroups(){s(`${this.formId} [data-sync-with-db]`).on("change",(async e=>{let t,n=e.target,i=s(n).attr("name"),r=s(n).attr("data-db");if(t="checkbox"===s(n).attr("type")?n.checked?1:0:"radio"===s(n).attr("type")?s(n).closest(".settings-panel").find(`input[type="radio"][name="${i}"]:checked`).value():s(n).value(),"electron-main"===r?(console.log("Setting option in Electron sqlite database",i,t),await Bridge.ipcAsk("set-option",{option:i,value:t})):(console.log("Setting option in localStorage",i,t),window.localStorage.setItem(i,t)),this._callbacks.onSettingChange.length)for(let n of this._callbacks.onSettingChange)n(i,t,e)}))}openSettingsPanel(e){if(!s(".settings-panel").hasClass("open")){if(s("#app").addClass("settings-open"),s(".settings-panel").addClass("open"),!e){let t=s(this.tabs.selector).attr("data-current-tab");t&&(e=t)}this.tabs.showTab(e),s().keepFocusWithin(".settings-panel")}}registerCallback(e,t){this._callbacks[e].push(t)}getFieldTemplates(){let e=["advanced/developer","advanced/factory-reset","general/lang","general/confirm-electron-quit","general/notifications","general/start-page","general/updates","modals/folder-structure","playback/flags","theme/color-theme","theme/custom-css","theme/swatches"],t={};for(let n of e)t[`settings-field/${n}`]=this.getFieldTemplate(n);return t}getFieldTemplate(e){switch(e){case"advanced/developer":return'\n        <div class="form-group">\n          <h4 class="group-title">{i18n{settings.developer.title}}</h4>\n        \n          <input type="checkbox" data-sync-with-db name="developer_mode" data-label="{i18n{settings.developer.enable-label}}">\n        </div>';case"advanced/factory-reset":return'\n        <div class="form-group factory-reset-group">\n          <h4 class="group-title">{i18n{settings.factory-reset.title}}</h4>\n\n          <button class="danger" type="button" name="factory-reset">\n            <span tabindex="-1">{i18n{settings.factory-reset.desc}}</span>\n          </button>\n        </div>';case"general/lang":return'\n        <div class="form-group">\n          <h4 class="group-title">{i18n{settings.language.title}}</h4>\n\n          <select name="lang" data-sync-with-db>\n            <option value="en" selected="selected">English</option>\n            <option value="fr">Français</option>\n          </select>\n        </div>';case"general/notifications":return'\n        <div class="form-group">\n          <h4 class="group-title">{i18n{settings.notifications.title}}</h4>\n\n          <input type="checkbox" data-sync-with-db name="notification_on_song_change" data-label="{i18n{settings.notifications.song-change-label}}">\n        </div>';case"general/confirm-electron-quit":return'\n        <div class="form-group">\n          <input type="checkbox" data-sync-with-db data-db="electron-main" name="confirm_electron_quit" data-label="{i18n{settings.confirm-electron-quit}}">\n        </div>';case"general/start-page":return'\n        <div class="form-group">\n          <h4 class="group-title">{i18n{settings.start-page.title}}</h4>\n\n          <select name="start_page" data-sync-with-db>\n            <optgroup label="{i18n{nav.music.title}}">\n              <option value="/explore-music">{i18n{nav.music.explore}}</option>\n              <option value="/artists">{i18n{nav.music.artists}}</option>\n              <option value="/music-releases">{i18n{nav.music.releases}}</option>\n              <option value="/tracks">{i18n{nav.music.tracks}}</option>\n              <option value="/playlists">{i18n{nav.music.playlists}}</option>\n              <option value="/music-genres">{i18n{nav.music.genres}}</option>\n            </optgroup>\n          </select>\n        </div>';case"general/updates":return'\n        <div class="form-group">\n          \x3c!-- <h4 class="group-title">{i18n{settings.updates.title}}</h4> --\x3e\n\n          <input type="checkbox" data-sync-with-db name="auto_check_for_updates" data-label="{i18n{settings.updates.auto-check-label}}">\n        </div>\n        \n        <div class="form-group">\n          <button name="manually-check-for-updates" class="btn" type="button">{i18n{settings.updates.manual-check-label}}</button>\n        </div>';case"modals/folder-structure":return'\n        <div class="folder-structure-guide">\n          <div class="modal-header">\n            <h2>{i18n{folder-structure-guide.title}}</h2>\n          </div>\n\n          <div class="text-content">\n            {i18n{folder-structure-guide.desc-before-examples}}\n          </div>\n\n          <div class="folder-structure-examples">\n            \x3c!-- Music Examples --\x3e\n            <h3>{i18n{folder-structure-guide.example.music.title}}</h3>\n\n            <div class="code-blocks half-half">\n              <code>\n                /{i18n{folder-structure-guide.example.music.code.artist}}<br>\n                &nbsp;&nbsp;/{i18n{folder-structure-guide.example.music.code.album}}<br>\n                &nbsp;&nbsp;&nbsp;&nbsp;• {i18n{folder-structure-guide.example.music.code.song}}<br>\n                &nbsp;&nbsp;&nbsp;&nbsp;• {i18n{folder-structure-guide.example.music.code.cover-art}}<br>\n              </code>\n              <div class="or">{i18n{or}}</div>\n              <code>\n                /{i18n{folder-structure-guide.example.music.code.artist}}<br>\n                &nbsp;&nbsp;/{i18n{folder-structure-guide.example.music.code.album}}<br>\n                &nbsp;&nbsp;&nbsp;&nbsp;/{i18n{folder-structure-guide.example.music.code.disc}}<br>\n                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;• {i18n{folder-structure-guide.example.music.code.song}}<br>\n                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;• {i18n{folder-structure-guide.example.music.code.cover-art}}<br>\n              </code>\n            </div>\n          </div>\n\n          <div class="supported-types">\n            <h3>{i18n{folder-structure-guide.supported-types.title}}</h3>\n\n            <table class="informational">\n              <tr>\n                <td>{i18n{folder-structure-guide.example.music.title}}</td>\n                <td>\n                  <code class="inline">.mp3</code>\n                  <code class="inline">.flac</code>\n                </td>\n              </tr>\n              <tr>\n                <td>{i18n{folder-structure-guide.example.tv-movies.title}}</td>\n                <td>\n                  <code class="inline">.mp4</code>\n                </td>\n              </tr>\n              <tr>\n                <td>{i18n{folder-structure-guide.supported-types.artwork}}</td>\n                <td>\n                  <code class="inline">.jpg</code>\n                  <code class="inline">.png</code>\n                  <code class="inline">.gif</code>\n                </td>\n              </tr>\n            </table>\n          </div>\n        </div>';case"playback/flags":return'\n        <div class="form-group">\n          <h4 class="group-title">{i18n{settings.music-playback.title}}</h4>\n\n          <input type="checkbox" data-sync-with-db name="always_load_whole_song" data-label="{i18n{settings.music-playback.always-load-whole-song}}">\n        </div>';case"theme/color-theme":return'\n        <div class="form-group">\n          <h4 class="group-title">{i18n{settings.color-theme.title}}</h4>\n\n          <select name="color_theme" data-sync-with-db>\n            <option value="dark" selected="selected">{i18n{settings.color-theme.option.dark}}</option>\n            <option value="light">{i18n{settings.color-theme.option.light}}</option>\n          </select>\n        </div>';case"theme/custom-css":return'\n        <div class="form-group">\n          <h4 class="group-title">{i18n{settings.custom-css.title}}</h4>\n\n          <div class="instructions">\n            <div class="slidetoggle slim">\n              <button class="label">\n                <span tabindex="-1">\n                  <i class="warning-icon fas fa-exclamation-triangle"></i>\n                  {i18n{settings.custom-css.notice}}\n                </span>\n              </button>\n\n              <span class="content">{i18n{settings.custom-css.instructions}}</span>\n            </div>\n          </div>\n\n          <textarea class="custom-css" data-sync-with-db name="custom_css"></textarea>\n        </div>';case"theme/swatches":return'\n        <div class="form-group">\n          <h4 class="group-title">{i18n{settings.accent-color.title}}</h4>\n\n          <div class="swatches">\n            <input type="radio" name="accent_color" data-sync-with-db title="The Last Popsicle Purple" type="button" class="color-swatch clicks" value="#a174dd">\n            <input type="radio" name="accent_color" data-sync-with-db title="Flamingo Jam Pink" type="button" class="color-swatch clicks" value="#e9219c">\n            <input type="radio" name="accent_color" data-sync-with-db title="Rapper Name lil\'Blue" type="button" class="color-swatch clicks" value="#4da3bd">\n            <input type="radio" name="accent_color" data-sync-with-db title="The Bold and the Bluetiful" type="button" class="color-swatch clicks" value="#3793cf">\n            <input type="radio" name="accent_color" data-sync-with-db title="Cantaloupe Green" type="button" class="color-swatch clicks" value="#57b983">\n            <input type="radio" name="accent_color" data-sync-with-db title="Zergling Rush! Green" type="button" class="color-swatch clicks" value="#379c3f">\n            <input type="radio" name="accent_color" data-sync-with-db title="Nuclear Warning Yellow" type="button" class="color-swatch clicks" value="#ccb118">\n            <input type="radio" name="accent_color" data-sync-with-db title="At Least It\'s Not Brown, Orange" type="button" class="color-swatch clicks" value="#d45912">\n            <input type="radio" name="accent_color" data-sync-with-db title="Alien Invasion Red" type="button" class="color-swatch clicks" value="#cc4c43">\n            <input type="radio" name="accent_color" data-sync-with-db title="Soulless Grey" type="button" class="color-swatch clicks" value="#575757">\n          </div>\n        </div>'}}}f.register("server-app",class extends C{async onSpawn(){if(s().enforceSingleton("server-app",this))return;const e=await Bridge.ipcAsk("get-option","lang");"en"===Router.currentLang&&"en"!==e&&Router.setLang(e),this.boundAnnouncementListener=w.bind(this),this.boundOnOptionChange=this.onOptionChange.bind(this),Bridge.ipcListen("announcements",this.boundAnnouncementListener),Bridge.ipcListen("option-change",this.boundOnOptionChange),s(this).attr("color-theme","dark")}async onBuild(){await this.preLoadQueries(),this.innerHTML=await d("/elements/server-app/server-app.html")}onLoad(){this.registerEventHandlers(),window.Router.go("/overview",!0)}onRemoved(){Bridge.removeListener("announcements",this.boundAnnouncementListener)}registerEventHandlers(){s("a.external").on("click",this,(function(e){e.preventDefault();let t=s(this).attr("href");Bridge.ipcSay("open-url",t)})),s("a.file-path").on("click",this,(function(e){e.preventDefault();let t=s(this).attr("href");k.showItemInFolder(t)})),s(".slidetoggle .label").on("click",this,(function(e){s(this).closest(".slidetoggle").toggleClass("open")})),window.addEventListener("blur",(e=>{"1"===localStorage.getItem("close-window-on-blur")&&window.close()}))}onOptionChange(e){"custom_css"===e.option&&this.injectCustomCss(),"developer_mode"===e.option&&this.enableDeveloperMode(e.newValue)}async preLoadQueries(){await this.injectCustomCss(),await this.setColors()}}),f.register("server-status",class extends f{onSpawn(){this.setStatus("loading"),this.uptimeIncrementer=null}async onBuild(){this.innerHTML=await d("/elements/server-status/server-status.html")}async onLoad(){if(!("httpServer"in Bridge))return console.warn("ServerStatus detected malformed server information in window.Bridge"),void this.setStatus("offline");await this.testConnection()?this.setStatus("online"):this.setStatus("offline")}onRemoved(){}async setStatus(e){s(this).attr("status",e),this.stopUptimeIncrementing();let t=s(this).find(".info .url a");switch(e){case"online":this.props.url=`${Bridge.httpServer.host}:${Bridge.httpServer.port}`,t.attr("href",`${Bridge.httpServer.scheme}${Bridge.httpServer.host}:${Bridge.httpServer.port}`),this.props.uptime=this.calcUptime(),this.props.version=await this.getVersion(),this.startUptimeIncrementing();break;case"offline":this.props.url="javascript:;",t.attr("href","N/A")}}async testConnection(){return this.setStatus("connecting"),200===(await Bridge.httpApi("/status")).status}async getVersion(){if(this.version)return this.version;let e=await Bridge.httpApi("/version");return this.version=2===e.statusRange?e.response:"(Unknown)",this.version}startUptimeIncrementing(){this.uptimeIncrementer=setInterval((()=>{this.props.uptime=this.calcUptime()}),1e3)}stopUptimeIncrementing(){this.props.uptime="-",clearInterval(this.uptimeIncrementer)}calcUptime(){if(!("startTime"in Bridge.httpServer))return console.warn("Cannot calculate uptime because Bridge does not have HTTP server start time"),"-";let e=Date.now()-Bridge.httpServer.startTime,t=Number(e/1e3),n=Math.floor(t/86400),s=Math.floor(t%86400/3600),i=Math.floor(t%3600/60),r=Math.floor(t%60);return e<6e4?`${r}s`:e<36e5?`${i}m ${r}s`:e<864e5?`${s}h ${i}m ${r}s`:e>=864e5?`${n}d ${s}h ${i}m ${r}s`:void 0}}),f.register("server-actions",class extends f{onSpawn(){if(!("httpServer"in Bridge))return console.warn("ServerActions cannot render because Bridge is missing the httpServer property"),!1}async onBuild(){this.innerHTML=await d("/elements/server-actions/server-actions.html")}async onLoad(){this.quitBtn=this.querySelector('button[name="quit"]'),this.registerEventHandlers()}onRemoved(){}registerEventHandlers(){this.quitBtn.addEventListener("click",(()=>{Bridge.ipcSay("quit")}))}}),f.register("server-settings",class extends B{onSpawn(){s().enforceSingleton("server-settings",this)}async onBuild(){let e=this.getFieldTemplates();this.innerHTML=await d("/elements/server-settings/server-settings.html",e)}async onLoad(){this.formSetup()}onRemoved(){this.removeEventHandlers()}}),f.register("index-controls",class extends f{async onSpawn(){}async onBuild(){this.innerHTML=await d("/elements/index-controls/index-controls.html")}async onLoad(){this.bigButtonEl=this.querySelector(".big-button"),this.stateEl=this.querySelector(".state"),this.progressBar=s(this).find(".progress .fill"),await this.syncWithLastKnownState(),this.registerEventHandlers(),E(this.querySelector("#indexing-options")),this.indexingServiceReplyChannel="IndexingService:Announcements",this.boundIndexingServiceListener=this.onIndexingServiceAnnouncement.bind(this),Bridge.ipcListen(this.indexingServiceReplyChannel,this.boundIndexingServiceListener)}onRemoved(){Bridge.removeIpcListener(this.indexingServiceReplyChannel,this.boundIndexingServiceListener)}registerEventHandlers(){this.bigButtonEl.addEventListener("click",(e=>{switch(this.getStatus()){case"inactive":this.startIndexing();break;case"starting":case"scanning":case"syncing":s(this.bigButtonEl).hasClass("glow-red")||(s(this.bigButtonEl).addClass("glow-red"),setTimeout((()=>{s(this.bigButtonEl).removeClass("glow-red")}),1e3));break;case"importing":this.pauseIndexing();break;case"paused":this.resumeIndexing();break;case"summary":this.setStatus("inactive"),this.startIndexing()}}))}async syncWithLastKnownState(){let e=await Bridge.ipcAsk("IndexingService:GetState");console.log("lastKnownState",e),e.paused&&this.setStatus("paused"),e.lastIndexingServiceAnnouncement&&this.onIndexingServiceAnnouncement(e.lastIndexingServiceAnnouncement)}getStatus(){return s(this).attr("status")}setStatus(e){switch(s(this).attr("status",e),s(this).find(".state .single-state").removeClass("show"),s(this).find(`.state .single-state.${e}`).addClass("show"),e){case"starting":case"scanning":case"syncing":case"importing":case"summary":case"paused":s(this).addClass("wide");break;default:s(this).removeClass("wide")}}async maybeConfirmDangerousIndexingOperation(){return!!(await Bridge.httpApi("/directories")).response.length||!(await new class{constructor(e){return(async()=>{if("object"!=typeof e)throw new Error("Query requires a query object");if(!("table"in e))throw new Error("Query queryObj requires a table key");return this.mode="mode"in e?e.mode:"http",this.serverEndpoint="/query",this.serverMethod="POST",this.queryObj=Object.assign({page:1,itemsPerPage:100,columnCompare:"AND",equalityOperator:"=",prefix:"server_"},e),this.buildSql(),await this.execute(),await this.calculateTotals(),this.page=this.queryObj.page,this})()}buildSql(){let e="";e+=this._buildSelectClause(),e+=this._buildFromClause(),e+=this._buildJoinClause(),e+=this._buildWhereClause(),e+=this._buildOrderByClause(),e+=this._buildLimitClause(),e+=this._buildOffsetClause(),this.sql=e}async execute(){return this.results=await this._send(this.sql),this.afterExecute(),this}async _send(e){return"http"===this.mode?(await Bridge.httpApi(this.serverEndpoint,this.serverMethod,e)).response:"ipc"===this.mode?await Bridge.ipcAsk("sql",e):void 0}afterExecute(){if("join"in this.queryObj&&this.results.length)for(let e of this.results)"_primaryTableRowId"in e&&(e.id=e._primaryTableRowId,delete e._primaryTableRowId)}_buildSelectClause(){let e="";return"join"in this.queryObj&&(e=`\n\t${this.queryObj.prefix}${this.queryObj.table}.id AS _primaryTableRowId,`),`SELECT${e}\n\t*`}_buildFromClause(){return`\nFROM\n\t${this.queryObj.prefix}${this.queryObj.table}`}_buildJoinClause(){if(!("join"in this.queryObj)||"object"!=typeof this.queryObj.join||!Object.keys(this.queryObj.join).length)return"";let e;e=Array.isArray(this.queryObj.join)||"object"!=typeof this.queryObj.join||null===this.queryObj.join?this.queryObj.join:[this.queryObj.join];let t="";for(let n of e){if(!("table"in n))throw new Error('JOIN was given without the "table" key');if(!("on"in n))throw new Error('queryObj.join was given without the "on" key');let e="type"in n?n.type:"LEFT JOIN",s="equalityOperator"in n?n.equalityOperator:"=";t+=`\n${e}\n\t${this.queryObj.prefix}${n.table}`;for(let[e,i]of Object.entries(n.on))t+=`\n\tON ${this.queryObj.prefix}${this.queryObj.table}.${e} ${s} ${this.queryObj.prefix}${n.table}.${i}`}return t}_buildWhereClause(){if(!("columns"in this.queryObj)||"object"!=typeof this.queryObj.columns||!Object.keys(this.queryObj.columns).length)return"";let e="\nWHERE\n",t=this.queryObj.columns;Array.isArray(t)||(t=[{...t}]);for(let n of t){let t=this.queryObj.equalityOperator;"equalityOperator"in n&&(t=n.equalityOperator,delete n.equalityOperator);for(let[s,i]of Object.entries(n)){if(s.includes(".")&&(s=this.queryObj.prefix+s),"string"==typeof i)e+=`\t${s} ${t} '${i}'`;else if("number"==typeof i)e+=`\t${s} ${t} ${i}`;else if(Array.isArray(i)){let n="";for(let e of i)"string"==typeof e?n+=`"${e}",`:"number"==typeof e&&(n+=`${e},`);n=n.substr(0,n.length-1),e+=`\t${s} ${t} (${n})`}e+="\n"+this.queryObj.columnCompare+"\n"}}return e=e.slice(0,e.length-(this.queryObj.columnCompare.length+2)),e}_buildOrderByClause(){if(!("orderBy"in this.queryObj))return"";if("rand"===this.queryObj.orderBy)return"\nORDER BY RANDOM()";if("object"!=typeof this.queryObj.orderBy||!Object.keys(this.queryObj.orderBy).length)return"";let e="\nORDER BY";for(let[t,n]of Object.entries(this.queryObj.orderBy))e+=`\n\t${t} COLLATE NOCASE ${n},`;return e=e.slice(0,e.length-1),e}_buildLimitClause(){return-1===this.queryObj.itemsPerPage?"":`\nLIMIT\n\t${this.queryObj.itemsPerPage}`}_buildOffsetClause(){return-1===this.queryObj.itemsPerPage||1===this.queryObj.page?"":`\nOFFSET\n\t${this._calculateOffset()}`}_calculateOffset(){return this.queryObj.page*this.queryObj.itemsPerPage-this.queryObj.itemsPerPage}async goToPage(e){return e===this.page||(e>this.pages&&(e=this.pages),this.queryObj.page=e,this.page=e,this.buildSql(),await this.execute()),this}async calculateTotals(){if(-1===this.queryObj.itemsPerPage)return this.pages=1,this.totalResults=this.results.length,this;let e=this.sql;e=e.replace(/[^*]*/,""),e=e.replace("*","SELECT COUNT(*) AS numItems"),e=e.replace(`OFFSET\n\t${this._calculateOffset()}`,"");let t=await this._send(e);return this.totalResults=t[0].numItems,this.pages=Math.ceil(Number(t[0].numItems)/Number(this.queryObj.itemsPerPage)),this}}({table:"music_tracks",itemsPerPage:1})).results.length||confirm(L("server.index-directories.no-dirs-warning"))}async startIndexing(){if("inactive"!==this.getStatus())return void console.warn("Cannot start indexing while already indexing");if(!await this.maybeConfirmDangerousIndexingOperation())return;this.setStatus("starting"),console.log("starting indexing");let e=await Bridge.ipcAsk("IndexingService:Begin",{mode:s(this).find('.option [name="mode"]').value()||"quick"});return e||this.handleInternalError("Something went wrong when starting the IndexingService."),e}async pauseIndexing(){"importing"===this.getStatus()?await Bridge.ipcAsk("IndexingService:Pause")&&(this.setStatus("paused"),console.log("Pausing importing")):console.warn("Cannot pause the indexer unless it is importing")}async resumeIndexing(){"paused"===this.getStatus()?await Bridge.ipcAsk("IndexingService:Resume")&&(this.setStatus("importing"),console.log("Resuming importing")):console.warn("Cannot resume the indexer unless it is paused")}onIndexingServiceAnnouncement(e){if(console.log("IndexingService Announcement",e),"object"==typeof e&&"props"in e)for(let[t,n]of Object.entries(e.props))this.props[t]=n;switch(e.action){case"internalError":this.handleInternalError(e.data);break;case"setStatus":this.setStatus(e.data);break;case"scanFoundFile":this.setStatus("scanning"),this.props.scannedFile=L("server.index-controls.scanned-count").replace("{{n}}",e.data);break;case"syncAddedFileToIndex":this.setStatus("syncing"),s(this).find(".syncing").removeClass("removed").addClass("added");let t=e.data.split(/\\|\//gm).pop();this.props.addedFile=t;break;case"syncDeletedFileFromIndex":this.setStatus("syncing"),s(this).find(".syncing").removeClass("added").addClass("removed");let n=e.data.split(/\\|\//gm).pop();this.props.removedFile=n;break;case"fileImported":case"fileSkipped":case"fileUpdated":case"fileErrored":"paused"!==this.getStatus()&&this.setStatus("importing"),this.updateProgressBar(e.percentage);break;case"summary":s(this.bigButtonEl).addClass("glow-off"),this.setStatus("summary"),this.props.numNew=e.data.new.length,this.props.numUpdated=e.data.updated.length,this.props.numSkipped=e.data.skipped.length,this.props.numDeleted=e.data.deleted.length,this.props.numErrored=e.data.errored.length,s(this).find(".report-summary-path").attr("href",e.data.report)}}handleInternalError(e){console.log(e),s(this).addClass("has-internal-error"),this.props.internalErrorMessage=e}updateProgressBar(e){this.progressBar.css({width:`${e}%`})}}),f.register("index-stats",class extends f{onSpawn(){}async onBuild(){this.innerHTML=await d("/elements/index-stats/index-stats.html")}async onLoad(){this.refresh(),this.indexingServiceReplyChannel="IndexingService:Announcements",this.boundIndexingServiceListener=this.onIndexingServiceAnnouncement.bind(this),Bridge.ipcListen(this.indexingServiceReplyChannel,this.boundIndexingServiceListener)}onRemoved(){Bridge.removeIpcListener(this.indexingServiceReplyChannel,this.boundIndexingServiceListener)}async refresh(){let e=await Bridge.httpApi("/indexing-service/stats");this.props.numMusicFiles=e.response.music,this.props.numPhotoFiles=e.response.photos,this.props.numCinemaFiles=e.response.cinema,this.props.numBookFiles=e.response.books}onIndexingServiceAnnouncement(e){if("fileImported"===e.action){let t=s(this).find(`[data-type="${e.type}"] .num`).el(),n=parseInt(t.innerHTML)+1;t.innerHTML=n}}}),f.register("index-directories",class extends f{onSpawn(){}async onBuild(){this.innerHTML=await d("/elements/index-directories/index-directories.html")}async onLoad(){await this.showDirsInDb(),this.enableDropArea(this.querySelector(".droparea"),this.dropAreaHandler.bind(this))}onRemoved(){}async addPath(e){if(404!==(await Bridge.httpApi(`/directory?path=${encodeURIComponent(e)}`,"HEAD")).status)return;let t=await Bridge.httpApi("/directory","POST",{dir_path:e,dir_multimedia_type:"music"});201===t.status&&this.insertPathIntoDOM(t.response)}async removePath(e){let t=await Bridge.httpApi(`/directory/${e}`,"DELETE");200===t.status?this.removePathFromDOM(e):console.error(t.response)}async insertPathIntoDOM(e){let t=s(this).getTemplate(".dir");t=await d(t,{path:e.dir_path,pathId:e.id});let n=s(this).find(".user-directories").appendHtml(t);n.find("a.remove").el().addEventListener("click",(e=>{let t=n.find("[data-file-path]").attr("data-path-id");this.removePath(t)}))}removePathFromDOM(e){s(this).find(`[data-path-id="${e}"]`).closest(".user-directory").remove(),s(this).find(".user-directory").els.length||s(this).find(".user-directories").removeClass("has-folders")}async dropAreaHandler(e,t){let n=[];for(let e=0;e<t.length;e++)""===t[e].type&&n.push(t[e].path);if(n.length){for(let e of n)this.addPath(e);s(this).find(".user-directories").addClass("has-folders")}}async showDirsInDb(){let e=await Bridge.httpApi("/directories");if(2!==e.statusRange)return void s(this).find('.error-message[data-error="load-error"]').show();let t=e.response;if(t.length){s(this).find(".user-directory").remove();for(let e of t)this.insertPathIntoDOM(e);s(this).find(".user-directories").addClass("has-folders")}}}),f.register("connected-devices",class extends f{onSpawn(){this.watchAttr("show-connected-server-uis",(()=>{this.removeConnectedDevices(),this.sync()}))}async onBuild(){this.innerHTML=await d("/elements/connected-devices/connected-devices.html")}async onLoad(){this.listEl=this.querySelector(".device-list"),await this.sync(),Bridge.wsListen("new-connection",(e=>{console.log("Server says new device connected",e),this.insertConnectedDevice(e,"top")})),Bridge.wsListen("connection-closed",(e=>{console.log("Server says device disconnected",e),this.removeConnectedDevice(e)}))}onRemoved(){}async sync(){console.log("Syncing connected devices");let e=await Bridge.httpApi("/connected-devices");if(2===e.statusRange){for(let t of e.response)(s(this).attr("show-connected-server-uis")||"cardinalserver"!==t.app.name)&&(s(this).find(`[connection-id="${t.connectionId}"]`).els.length||this.insertConnectedDevice(t.connectionId));this.updateNumDevices()}else this.showError("Could not reach server.")}insertConnectedDevice(e,t="bottom"){let n=`<connected-device connection-id="${e}"></connected-device>`;"top"===t?s(this.listEl).prependHtml(n):"bottom"===t&&s(this.listEl).appendHtml(n),this.updateNumDevices()}removeConnectedDevice(e){s(this).find(`connected-device[connection-id="${e}"]`).remove(),this.updateNumDevices()}removeConnectedDevices(){s(this).find("connected-device").remove(),this.updateNumDevices()}showError(e){this.listEl.innerHTML=`<p class="error-message">${e}</p>`,s(this).addClass("error")}updateNumDevices(){s(this).attr("num-devices",s(this).find("connected-device").els.length)}}),f.register("connected-device",class extends f{async onSpawn(){if(this.connectionId=s(this).attr("connection-id"),!this.connectionId)throw new Error("Connection ID required");this.state=null,this._currentTimeInterval=null;let e=await Bridge.httpApi(`/connected-devices/${this.connectionId}`);if(2===e.statusRange){if(e.response.connectionId!==this.connectionId)throw new Error("Somehow, the connection ID's do not match");this._boundStateUpdateListener=this.onDeviceStateChange.bind(this),Bridge.wsListen("client-to-server-state-update",this._boundStateUpdateListener),this.deviceProfile=e.response,this.state=e.response.state}else this.showError(e.response)}shouldBuild(){return!0}async onBuild(){s(this).attr("app",this.deviceProfile.app.name),"cardinalserver"===this.deviceProfile.app.name?this._buildServerConnection():"cardinalmusic"===this.deviceProfile.app.name&&this._buildMusicConnection()}_buildGeneralInfo(){this.props.ip=this.deviceProfile.client.ip,this.props.version=this.deviceProfile.app.version,s(this).attr("os",this.deviceProfile.client.os.name.toLowerCase().replace(" ",""))}async _buildServerConnection(){const e={appName:L("cardinalserver")};this.innerHTML=await d("/elements/connected-device/server.html",e),this._buildGeneralInfo(),s(this).find(".icon img").attr("src","images/logo-server.svg")}async _buildMusicConnection(){const e={appName:L("cardinalmusic")};this.innerHTML=await d("/elements/connected-device/music.html",e),this._buildGeneralInfo(),s(this).find(".icon img").attr("src","images/logo-music.svg"),s(this).attr("playback-state","stopped"),this.updateClientState()}async onLoad(){s(this).find("[data-control]").each((e=>{e.addEventListener("click",(t=>{let n=s(e).attr("data-control");console.log("Sending playback instruction to client",n),Bridge.wsSay("server-to-client-instruction",{client:s(this).attr("connection-id"),instruction:"remote-playback-control",command:n})}))}))}onRemoved(){Bridge.removeWsListener("client-to-server-state-update",this._boundStateUpdateListener)}refresh(){}onDeviceStateChange(e){this.getAttribute("connection-id")===e.connectionId&&(this.state=e,this.updateClientState())}updateClientState(){console.log("updateClientState()",this.state),this.state&&(s(this).attr("playback-state",this.state.state),s(this).attr("playback-method",this.state.method),"playing"===this.state.state||"paused"===this.state.state?(this.props.track=this.state.track.track_title,this.props.release=this.state.track.meta.album,this.props.artist=this.state.track.meta.artist,this.props.currentTime=this.state.currentTime,this.props.totalTime=this.state.totalTime,this.beginTimeUpdating()):this.stopTimeUpdating())}showError(e){this.innerHTML=`<p class="error-message">${e}</p>`,s(this).addClass("error")}beginTimeUpdating(){let e=this.querySelector('[data-prop="currentTime"]');this.stopTimeUpdating(),this._currentTimeInterval=setInterval((()=>{if("stopped"===this.state.state)throw new Error("Interval should be destroyed when the music is stopped, find your bug.");this.state.currentSeconds++,this.state.currentTime=s().convertSecondsToHHMMSS(this.state.currentSeconds),s(e).html(this.state.currentTime)}),1e3)}stopTimeUpdating(){clearInterval(this._currentTimeInterval)}}),f.register("web-apps",class extends f{onSpawn(){this.musicUrl=`${Bridge.httpServer.scheme}${Bridge.httpServer.host}:${Bridge.httpServer.port}/music`}async onBuild(){this.innerHTML=await d("/elements/web-apps/web-apps.html",{musicUrl:this.musicUrl})}async onLoad(){this.registerEventHandlers(),this.props.musicUrl=this.musicUrl}onRemoved(){}registerEventHandlers(){this.querySelector(".info-btn").addEventListener("click",(e=>{s(this).find(".help").toggleClass("open")}))}}),async function(){if(window.Bridge=new i,await window.Bridge.init("ipc"),!window.Bridge.ipcConnectionEstablished)throw new Error("Could not establish IPC connection to Electron");const e=await window.Bridge.ipcAsk("get-web-server-info");if(await window.Bridge.init("http",e.http),!window.Bridge.httpConnectionEstablished)throw new Error("Could not establish connection to HTTP server");if(await window.Bridge.init("ws",e.ws),!window.Bridge.wsConnectionEstablished)throw new Error("Could not establish connection to server WebSocket server");window.Router=new g({root:"#view",mode:"electron",langs:["en","fr"],defaultLang:"en",cacheViews:!0,currentLang:"en",routes:await p("/routes.json")});let t=await window.Bridge.httpApi("/i18n");200===t.status?window.i18n=t.response:console.error("i18n strings HTTP route did not return with status 200"),document.body.innerHTML='<server-app id="app"></server-app>',i.appDebug&&console.log("<server-app> injected")}()})()})();